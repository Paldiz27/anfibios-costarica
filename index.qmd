---
title: "Registros de presencia y especies de anfibios de Costa Rica"
author: "Pablo Palacios Díaz - C35849"
format: dashboard
scrolling: false 
httml:
  lang: es
  toc: true
---

```{r}
# Carga de paquetes
library(tidyverse)
library(DT)
library(sf)
library(leaflet)
library(leaflet.extras)
library(leafem)
library(terra)
library(readr)
library(dplyr)
library(plotly)
library(ggplot2)
library(viridis)
```

## Row {height=50%}

```{r}
AEspecies <-
  read_delim(
    file = "especies-anfibios.csv"
    )
  
AEspecies <-
  AEspecies |>
  rename(
    Categoría = iucnRedListCategory,
    Especies = species
  )

```

```{r}
ARegistros <- 
   read_delim(
    file = "registros-anfibios.csv",
    col_select = c("species"),
   )

ARegistros <-
  ARegistros |>
  rename(
    Especies = species
    
  )

```

```{r}
UnionEspecies <-

  left_join(ARegistros, AEspecies,
    by = "Especies"
  )
```

```{r}
UnionEspecies |>
  datatable(
    options = list(
      pageLength = 10,
      language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
    )
  )
```

```{r}
barrasEspecies <-
  UnionEspecies |>
  ggplot(aes(x = fct_infreq(Categoría))) +
  geom_bar(
    aes(
      text = paste0(
        "Cantidad de Anfibios: ", after_stat(count)
      )
    ),
  ) +  ggtitle("Cantidad de Anfibios por Especie") +
  xlab("Categoría") +
  ylab("Cantidad de Anfibios")

# Gráfico de barras plotly
ggplotly(barrasEspecies, tooltip = "text") |> 
  config(locale = 'es')
```

```{r}

provincias <-
  st_read(
    "provincias.geojson",
    quiet = TRUE 
  )
provincias <-
  provincias |>
  st_transform(4326)

areas_de_Conservacion <-
  st_read("areas-conservacion.gpkg",
    quiet = TRUE)

areas_de_Conservacion <-
  areas_de_Conservacion |>
  st_transform(4326)

anfibios <-
  st_read(
    "registros-anfibios.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude", 
      "Y_POSSIBLE_NAMES=decimalLatitude"   
    ),
    quiet = TRUE
  )

# Asignación del CRS WGS84
st_crs(anfibios) <- 4326
  

```

```{r}
anfibios_union_conserva <-
  st_join(
    x = anfibios,
    y = dplyr::select(areas_de_Conservacion, nombre_ac),
    join = st_within
  )
```

```{r}
# Conteo de la cantidad de especies de félidos en cantones
riqueza_anfibios <-
  anfibios_union_conserva |>
  st_drop_geometry() |>
  group_by(nombre_ac) |>
  summarize(riqueza_especies = n_distinct(species, na.rm = TRUE))

# Despliegue de la cantidad de especies de félidos en cada cantón
riqueza_anfibios |>
  arrange(desc(riqueza_especies)) |>
  datatable(
    colnames = c("Nombre Área de Conservación", "Riqueza de especies de anfibios"),
    options = list(
      pageLength = 5,
      language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
    )
  )

# Unión (no espacial) de cantones y riqueza de especies
conserva_union_riqueza <-
  left_join(
    x = areas_de_Conservacion,
    y = dplyr::select(riqueza_anfibios, nombre_ac, riqueza_especies),
    by = "nombre_ac"
  ) |>
  replace_na(list(riqueza_especies = 0))

```

## Row {height=50%}

```{r}
colores_riqueza_especies <-
  colorNumeric(
    palette = "Reds",
    domain = anfibios_union_conserva$riqueza_especies,
    na.color = "transparent"
  )

colores_especies <- colorFactor(
  palette = viridis(length(unique(anfibios$species))), 
  domain = anfibios$species
)

leaflet() |>
  setView(
    lng = -84.19452,
    lat = 9.572735,
    zoom = 7) |>
  addTiles(group = "Mapa general (OpenStreetMap)") |>
  addProviderTiles(
    providers$CartoDB.Positron,
    providers$Esri.WorldImagery
  ) |>
  addPolygons(
    data = anfibios_union_conserva,
    fillColor = ~ colores_riqueza_especies(anfibios_union_conserva$riqueza_especies),
    fillOpacity = 0.8,
    color = "black",
    stroke = TRUE,
    weight = 1.0,
    popup = paste(
      paste("<strong>Cantón:</strong>", anfibios_union_conserva$nombre_ac),
      paste("<strong>Riqueza de especies:</strong>", anfibios_union_conserva$riqueza_especies),
      sep = '<br/>'
    ),
    group = "Riqueza de especies"
  )|>
  addLayersControl(
    baseGroups = c(
      "Mapa general (OpenStreetMap)", 
      "Imágenes satelitales (ESRI World Imagery)"
    ),
    overlayGroups = c("Provincias", "Áreas_de_Conservación")) |> 
  addResetMapButton() |> 
  addSearchOSM() |> 
  addMouseCoordinates() |> 
  addScaleBar(
    position = "bottomleft", 
    options = scaleBarOptions(imperial = FALSE)
  ) |> 
  addMiniMap(position = "bottomright") |> 
  addFullscreenControl() 
  
```

